name: Backend ESLint (controllers & DTOs)

on:
  pull_request:
    # Fire only when these files â€” or the workflow itself â€” change
    paths:
      - 'backend/src/**/*.controller.ts'
      - 'backend/src/**/*.dto.ts'
      - '.github/workflows/backend-lint.yml'

permissions:
  contents: read
  pull-requests: write   # â¬… needed for the comment step

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend   # stay inside backend/

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci --ignore-scripts

      # â”€â”€ Run ESLint, capture text output, preserve exit code â”€â”€
      - name: Lint controllers & DTOs
        id: eslint
        shell: bash
        run: |
          set +e
          npx eslint "src/**/*.controller.ts" "src/**/*.dto.ts" --max-warnings=0 -f unix >../eslint.txt
          echo "exit_code=$?"   >> "$GITHUB_OUTPUT"
          echo "report<<EOF"    >> "$GITHUB_OUTPUT"
          cat ../eslint.txt     >> "$GITHUB_OUTPUT"
          echo "EOF"            >> "$GITHUB_OUTPUT"

      # â”€â”€ Create or update a single comment with the full report â”€â”€
      - name: Post / update PR comment
        if: steps.eslint.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸš¨ ESLint errors in `*.controller.ts` / `*.dto.ts`
            <details><summary>Click to expand</summary>

            ```text
            ${{ steps.eslint.outputs.report }}
            ```

            </details>
          edit-mode: replace   # keep just one comment

      # â”€â”€ Fail the job if ESLint found errors â”€â”€
      - name: Fail if ESLint errored
        if: steps.eslint.outputs.exit_code != '0'
        run: exit 1
