name: Backend ESLint (controllers & DTOs)

on:
  pull_request:
    paths:
      - 'backend/src/**/*.controller.ts'
      - 'backend/src/**/*.dto.ts'
      - '.github/workflows/backend-lint.yml'

permissions:
  contents: read
  pull-requests: write           # needed to post the comment

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults: { run: { working-directory: backend } }

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci --ignore-scripts

      # OPTIONAL: only if you want to keep -f unix
      # - name: Install unix formatter
      #   run: npm install -D eslint-formatter-unix

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€  Lint & capture output  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run ESLint
        id: eslint
        shell: bash
        run: |
          set +e
          npx eslint "src/**/*.controller.ts" "src/**/*.dto.ts" --max-warnings=0 >../eslint.txt
          echo "exit_code=$?"           >> "$GITHUB_OUTPUT"
          echo 'report<<EOF'            >> "$GITHUB_OUTPUT"
          cat ../eslint.txt             >> "$GITHUB_OUTPUT"
          echo 'EOF'                    >> "$GITHUB_OUTPUT"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€  Post (or update) a single comment  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: PR summary comment
        if: steps.eslint.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸš¨ ESLint errors in DTOÂ &Â Controller files
            <details><summary>Click to expand</summary>

            ```text
            ${{ steps.eslint.outputs.report }}
            ```

            </details>
          edit-mode: replace           # keeps just one comment thread

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€  Fail the job when ESLint found errors  â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Fail if ESLint errored
        if: steps.eslint.outputs.exit_code != '0'
        run: exit 1
