name: Backend ESLint

on:
  pull_request:
    paths:
      # run the job only when backend source changes
      - 'backend/src/**/*.controller.ts'
      - 'backend/src/**/*.dto.ts'
      - '.github/workflows/backend-lint.yml'

permissions:
  contents: read
  pull-requests: write     # needed to create / update the single comment

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend deps
        working-directory: backend
        run: npm ci --ignore-scripts

      # ─────────────  ESLint + Reviewdog  ─────────────
      - name: Run ESLint (controllers & DTOs) → single PR comment
        uses: reviewdog/action-eslint@v1.33.2
        with:
          workdir: backend

          # ✦  Lint only the patterns you care about
          #    Brace‑expansion works with ESLint's fast-glob.
          eslint_flags: 'src/**/*.{controller,dto}.ts --max-warnings=0'

          # ✦  Reviewdog behaviour
          reporter: github-pr-check   # ONE aggregated comment
          filter_mode: nofilter         # include errors even on untouched lines
          level: error                  # display only error‑level problems
          fail_level: error             # mark job ❌ if any error remains

          github_token: ${{ secrets.GITHUB_TOKEN }}
