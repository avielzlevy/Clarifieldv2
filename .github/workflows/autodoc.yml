name: Backend ESLint (controllers & DTOs)

on:
  pull_request:
    # Fire only when these files â€” or the workflow itself â€” change
    paths:
      - 'backend/src/**/*.controller.ts'
      - 'backend/src/**/*.dto.ts'
      - '.github/workflows/backend-lint.yml'

permissions:
  contents: read
  pull-requests: write   # â¬… needed for the comment step

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend   # stay inside backend/

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci --ignore-scripts

      # â”€â”€ Run ESLint, capture text output, preserve exit code â”€â”€
      - name: Run ESLint
        id: eslint
        shell: bash
        run: |
          set +e
          # compact = singleâ€‘line output thatâ€™s easy to postâ€‘process
          RAW="$(npx eslint "src/**/*.controller.ts" "src/**/*.dto.ts" \
                --format compact --max-warnings=0)"
          EXIT=$?
      
          # â€¢ strip the long runner prefix
          # â€¢ turn â€œerrorâ€ â†’ dash, keep rule in backâ€‘ticks
          # â€¢ add bullet prefix
          REPORT="$(printf '%s\n' "$RAW" \
            | sed -E 's@.*/backend/src/@@' \
            | sed -E 's@ error @ â€” @' \
            | sed -E 's@  ([^ ]+)$@  (`\1`)@' \
            | sed 's@^@- @')"
      
          COUNT=$(printf '%s\n' "$REPORT" | grep -c '^- ')
          echo "exit_code=$EXIT"      >> "$GITHUB_OUTPUT"
          echo "report<<EOF"          >> "$GITHUB_OUTPUT"
          echo "### âŒ $COUNT ESLint errors" >> "$GITHUB_OUTPUT"
          echo                         >> "$GITHUB_OUTPUT"
          echo "$REPORT"               >> "$GITHUB_OUTPUT"
          echo "EOF"                   >> "$GITHUB_OUTPUT"

      - name: PR summary comment
        if: steps.eslint.outputs.exit_code != '0'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸš¨Â ESLint errors in `*.controller.ts`Â /Â `*.dto.ts`
            <details><summary>Click to expand</summary>

            ${{ steps.eslint.outputs.report }}

            </details>
          edit-mode: replace

      - name: PR summary comment
        if: steps.eslint.outputs.exit_code != '0'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.eslint.outputs.report }}
          edit-mode: replace

      # â”€â”€ Create or update a single comment with the full report â”€â”€
      - name: Post / update PR comment
        if: steps.eslint.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸš¨ ESLint errors in `*.controller.ts` / `*.dto.ts`
            <details><summary>Click to expand</summary>

            ```text
            ${{ steps.eslint.outputs.report }}
            ```

            </details>
          edit-mode: replace   # keep just one comment

      # â”€â”€ Fail the job if ESLint found errors â”€â”€
      - name: Fail if ESLint errored
        if: steps.eslint.outputs.exit_code != '0'
        run: exit 1
