name: Backend ESLint (controllers & DTOs)

on:
  pull_request:
    # Fire only when these files — or the workflow itself — change
    paths:
      - 'backend/src/**/*.controller.ts'
      - 'backend/src/**/*.dto.ts'
      - '.github/workflows/backend-lint.yml'

permissions:
  contents: read
  pull-requests: write   # ⬅ needed for the comment step

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend   # stay inside backend/

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with: { node-version: 20 }

      - name: Install deps
        run: npm ci --ignore-scripts

      # ── Run ESLint, capture text output, preserve exit code ──
      - name: Lint controllers & DTOs
        id: eslint
        shell: bash
        run: |
          set +e
          OUT=$(npx eslint "src/**/*.controller.ts" "src/**/*.dto.ts" -f compact --max-warnings=0)
          EXIT=$?
          COUNT=$(printf '%s\n' "$OUT" | grep -c ': error ')
          SUMMARY=$(printf '%s\n' "$OUT" |
            sed -E 's@.*/backend/src/@@' |
            awk -F: '{
              file=$1; line=$2; col=$3;
              $1=$2=$3=""; sub(/^:[^:]*:?/, ""); msg=$0;
              split(msg,a,"  "); rule=a[length(a)];
              printf "- **%s**:%s:%s — %s  (`%s`)\n", file,line,col,a[1],rule
            }')
          echo "exit_code=$EXIT" >> "$GITHUB_OUTPUT"
          echo "report<<EOF"     >> "$GITHUB_OUTPUT"
          echo "### ❌ ${COUNT} ESLint errors" >> "$GITHUB_OUTPUT"
          echo ""                 >> "$GITHUB_OUTPUT"
          echo "$SUMMARY"         >> "$GITHUB_OUTPUT"
          echo "EOF"              >> "$GITHUB_OUTPUT"

      - name: PR summary comment
        if: steps.eslint.outputs.exit_code != '0'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.eslint.outputs.report }}
          edit-mode: replace

      # ── Create or update a single comment with the full report ──
      - name: Post / update PR comment
        if: steps.eslint.outputs.report != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## 🚨 ESLint errors in `*.controller.ts` / `*.dto.ts`
            <details><summary>Click to expand</summary>

            ```text
            ${{ steps.eslint.outputs.report }}
            ```

            </details>
          edit-mode: replace   # keep just one comment

      # ── Fail the job if ESLint found errors ──
      - name: Fail if ESLint errored
        if: steps.eslint.outputs.exit_code != '0'
        run: exit 1
